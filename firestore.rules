// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Auth helpers
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Admin if:
    // - custom claim admin: true
    // - custom claim role == 'admin'
    // - hardcoded bootstrap UID (replace with your own as needed)
    // - OR users/{uid}.role == 'admin' (fallback when custom claims aren't set)
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true ||
        request.auth.token.role == 'admin' ||
        request.auth.uid == 'yKLvDUKtwOOaWLqefI6oZhocrRu1' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    function hasRestaurantOwnerRole() {
      return isAuthenticated() && request.auth.token.role == 'restaurant_owner';
    }

    function canAccessOrder(orderData) {
      return isAuthenticated() && (
        (orderData.customerId != null && orderData.customerId == request.auth.uid) ||
        (orderData.chefId != null && orderData.chefId == request.auth.uid) ||
        (orderData.restaurantId != null && orderData.restaurantId == request.auth.token.restaurantId) ||
        isAdmin()
      );
    }

    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // Users can read/write their own profile
      allow read, write: if isOwner(userId);

      // Allow create during registration (before user document exists)
      allow create: if isAuthenticated();

      // Allow admins to read all user profiles
      allow read: if isAdmin();
    }

    // ============================================================================
    // USER SUBCOLLECTIONS
    // ============================================================================
    
    // User addresses subcollection
    match /users/{userId}/addresses/{addressId} {
      // Allow users to read/write their own addresses
      allow read, write, create, delete: if isOwner(userId);
      
      // Allow admins to read all addresses
      allow read: if isAdmin();
    }
    
    // User cart subcollection
    match /users/{userId}/cart/{cartId} {
      // Allow users to manage their own cart
      allow read, write, create, delete: if isOwner(userId);
    }
    
    // User cart_items subcollection
    match /users/{userId}/cart/{cartId}/cart_items/{itemId} {
      // Allow users to manage their own cart items
      allow read, write, create, delete: if isOwner(userId);
    }
    
    // User coupon_usage subcollection
    match /users/{userId}/coupon_usage/{usageId} {
      // Allow users to manage their own coupon usage
      allow read, write, create, delete: if isOwner(userId);
    }
    
    // User notifications subcollection
    match /users/{userId}/notifications/{notificationId} {
      // Allow users to read their own notifications
      allow read: if isOwner(userId);
      
      // Allow users to update their notification read status
      allow update: if isOwner(userId);
      
      // Allow system to create notifications for users
      allow create: if isAdmin() || isOwner(userId);
      
      // Allow users to delete their own notifications
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // User sessions subcollection
    match /users/{userId}/sessions/{sessionId} {
      // Allow users to manage their own sessions
      allow read, write, create, delete: if isOwner(userId);
    }
    
    // User wishlist subcollection
    match /users/{userId}/wishlist/{wishlistId} {
      // Allow users to manage their own wishlist
      allow read, write, create, delete: if isOwner(userId);
    }
    
    // User order_history subcollection
    match /users/{userId}/order_history/{historyId} {
      // Allow users to read their own order history
      allow read: if isOwner(userId);
      
      // Allow users to update their order history
      allow update: if isOwner(userId);
      
      // Allow system to create order history for users
      allow create: if isAdmin() || isOwner(userId);
      
      // Allow users to delete their own order history
      allow delete: if isOwner(userId) || isAdmin();
    }

    // RESTAURANTS
    match /restaurants/{restaurantId} {
      // public read (catalog)
      allow read: if true;

      // owner
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      // admin
      allow create, update, delete: if isAdmin();

      // owner read own restaurant explicitly
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;

      // MENU ITEMS
      match /menu_items/{menuItemId} {
        allow read: if true;
        allow create, update, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow create, update, delete: if isAdmin();
      }

      // INVENTORY
      match /inventory/{inventoryId} {
        allow read, write, create, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow read, write, create, delete: if isAdmin();
      }

      // CHEFS (subcollection under restaurant)
      match /chefs/{chefId} {
        allow read: if true;
        allow create, update, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow create, update, delete: if isAdmin();
      }

      // NOTIFICATIONS
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow create: if isAdmin();
        allow update: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow delete: if isAdmin();
      }

      // CUISINES
      match /cuisines/{cuisineId} {
        allow read: if true;
        allow create, update, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow create, update, delete: if isAdmin();
      }

      // FOOD TYPES
      match /foodTypes/{foodTypeId} {
        allow read: if true;
        allow create, update, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
        allow create, update, delete: if isAdmin();
      }

      // REVIEWS (under restaurant)
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid ||
          isAdmin()
        );
      }
    }

    // MENU ITEMS (collectionGroup for cross-restaurant queries)
    match /{path=**}/menu_items/{menuItemId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated() &&
        get(/databases/$(database)/documents/restaurants/$(path[1])).data.ownerId == request.auth.uid;
      allow create, update, delete: if isAdmin();
    }

    // SERVICES (NEW) - used for service selection in forms
    match /services/{serviceId} {
      allow read: if true;                    // Populate dropdowns
      allow create, update, delete: if isAdmin();
    }
    
    match /services/{serviceId}/categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    // CUISINES (top-level)
    match /cuisines/{cuisineId} {
      allow read: if true;                 // anyone can read for dropdowns
      allow create, update, delete: if isAdmin();  // only admins manage cuisines
    }

    // FRESH SERVE
    match /freshserve/{productId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // CHEFS (top-level)
    match /chefs/{chefId} {
      allow read: if true;
      allow write: if isOwner(chefId) || isAdmin();
      allow delete: if isAdmin();
    }

    // SUPPLIES
    match /supplies/{productId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // FMCG
    match /fmcg/{productId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // PRODUCT CATEGORIES
    match /product_categories/{categoryId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // ORDERS
    match /orders/{orderId} {
      allow read, write: if isAuthenticated() && canAccessOrder(resource.data);
      allow create: if isAuthenticated() && (request.resource.data.customerId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
      
      // ORDER ITEMS subcollection
      match /order_items/{itemId} {
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
        allow create, write, delete: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
      }
      
      // PAYMENT subcollection
      match /payment/{paymentId} {
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
        allow create, write, delete: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
      }
      
      // STATUS HISTORY subcollection
      match /status_history/{historyId} {
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
        allow create, write, delete: if isAuthenticated() && (
          get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid || 
          isAdmin()
        );
      }
    }

    // PROMOTIONS
    match /promotions/{promotionId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // DELIVERY ZONES
    match /delivery_zones/{zoneId} {
      allow read: if true;
      allow write, create, delete: if isAdmin();
    }

    // APP CONFIG
    match /app_config/{configId} {
      allow read, write, create, delete: if isAdmin();
    }

    // CARTS
    match /carts/{cartId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // FAVORITES
    match /favorites/{favoriteId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ANALYTICS
    match /analytics/{eventId} {
      allow create: if isAdmin();
      allow read: if isAdmin();
      allow write, delete: if false;
    }
    
    match /cities/{cityId} {
      allow read: if true;                    // Anyone can read cities
      allow write, create, delete: if isAdmin(); // Only admins can manage cities

      // DELIVERY ZONES subcollection
      match /deliveryZones/{zoneId} {
        allow read: if true;                  // Anyone can read zones
        allow write, create, delete: if isAdmin(); // Only admins can manage zones

        // PINCODES subcollection under zones
        match /pincodes/{pincodeId} {
          allow read: if true;                // Anyone can read pincodes
          allow write, create, delete: if isAdmin(); // Only admins can manage pincodes
        }
      }
    }

    // COUPONS COLLECTION  
    match /coupons/{couponId} {
      allow read: if true;                    // Anyone can read coupons
      allow write, create, delete: if isAdmin(); // Only admins can manage coupons
    }

    // PROMOTIONS COLLECTION
    match /promotions/{promotionId} {
      allow read: if true;                    // Anyone can read promotions
      allow write, create, delete: if isAdmin(); // Only admins can manage promotions
    }

    // DEFAULT DENY
    match /{document=**} {
      allow read, write: if false;
    }
  }
}